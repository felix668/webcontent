(function(root,factory){if(typeof define==="function"&&(define.amd||define.cmd)){define("tippingData",function(exports){return factory(root,exports)})}else{root.tippingData=factory(root,{})}})(this,function(root,tippingData){var Http=function(){function request(method,url,data,success,error){data=function(){var params=[];for(var key in data){params.push(key+"="+data[key])}return params.join("&")}();var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){if(typeof success==="function"){success(JSON.parse(xhr.responseText))}}else{if(typeof error==="function"){error(xhr.status)}}};if(method==="GET"){url+="?"+data;data=null}xhr.open(method,url);if(method==="POST"){xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded")}xhr.send(data)}function get(url,data,success,error){request("GET",url,data,success,error)}function post(url,data,success,error){request("POST",url,data,success,error)}return{get:get,post:post}}();var api="http://tongji.liuliangyuanquan.com/api/data/";var prefix="";var id;var cnum=_param(prefix+"cnum")||0;var config;tippingData.config=function(userinfo,options){options.debug=options.debug||false;options.tid=options.tid||0;options.token=options.token||"";config=options;id=localStorage.getItem("tongji-task-"+config.tid)||0;_init(userinfo)};tippingData.shareTimeline=function(options){return _shareHandler(1,options)};tippingData.shareAppMessage=function(options){return _shareHandler(2,options)};tippingData._push=function(options){console.log(options);var data={};data.tid=config.tid;data.token=config.token;data.id=localStorage.getItem("tongji-task-"+config.tid);switch(options[0]){case"_trackEvent":data.category=options[1];data.action=options[2];data.label=options[3];data.value=options[4]||"";data.nodeid=options[5]||"";Http.post(api+"setAction",data,function(response){console.log(response.code)});break;default:break}};function _init(userinfo){var data={};data.tid=config.tid;data.token=config.token;data.id=id;data.cnum=cnum;data.pid=_param(prefix+"pid");data.read_from=_param("from");data.agent=navigator.userAgent;data.width=document.documentElement.clientWidth;if(userinfo.indexOf("openid")>0){try{userinfo=JSON.parse(userinfo);data.headimgurl=userinfo.headimgurl;data.nickname=userinfo.nickname;data.sex=userinfo.sex;data.country=userinfo.country;data.province=userinfo.province;data.city=userinfo.city}catch(e){if(config.debug){alert(e)}}}Http.post(api+"init",data,function(response){if(response.code===1){id=localStorage["tongji-task-"+config.tid]=response.data.id}else{if(config.debug){alert(response.msg)}}})}function _shareHandler(type,options){var _options=function(){var obj={};for(var key in options){obj[key]=options[key]}return obj}();var _params=function(){var obj={cnum:cnum,pid:id};var arr=[];for(var key in obj){arr.push(prefix+key+"="+obj[key])}return arr.join("&")}();if(_options.link.indexOf("?")===-1){_options.link+="?"+_params}else{_options.link+="&"+_params}_options.success=function(){Http.post(api+"share",{id:id,tid:config.tid,token:config.token,share:type});if(typeof options.success=="function"){options.success()}};return _options}function _param(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);if(r!=null)return decodeURIComponent(r[2]);return null}return tippingData});
